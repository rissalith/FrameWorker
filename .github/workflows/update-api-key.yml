name: Update API Key

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-key:
    name: Update DeepSeek API Key
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Update API key on server
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST "bash -s" << EOF
            set -e

            echo "ðŸ”‘ Updating DeepSeek API key..."

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd $DEPLOY_PATH

            # æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "MaxGamer/backend/.env" ]; then
              echo "âŒ .env file not found at MaxGamer/backend/.env"
              exit 1
            fi

            # å¤‡ä»½å½“å‰ .env æ–‡ä»¶
            cp MaxGamer/backend/.env MaxGamer/backend/.env.backup

            # æ›´æ–° API å¯†é’¥
            sed -i "s|VECTORAPI_KEY=.*|VECTORAPI_KEY=$DEEPSEEK_API_KEY|g" MaxGamer/backend/.env

            # éªŒè¯æ›´æ–°
            if grep -q "VECTORAPI_KEY=$DEEPSEEK_API_KEY" MaxGamer/backend/.env; then
              echo "âœ… API key updated successfully"
            else
              echo "âŒ Failed to update API key"
              # æ¢å¤å¤‡ä»½
              mv MaxGamer/backend/.env.backup MaxGamer/backend/.env
              exit 1
            fi

            # é‡å¯åŽç«¯å®¹å™¨
            echo "ðŸ”„ Restarting backend container..."
            docker restart maxgamer-api

            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            echo "â³ Waiting for container to start..."
            sleep 15

            # æµ‹è¯• API
            echo "ðŸ§ª Testing AI API..."
            response=\$(curl -s -X POST http://localhost:3000/api/ai/chat \
              -H 'Content-Type: application/json' \
              -d '{"interaction_type":"comment","message":"test","context":{"platform":"MaxGamer","page":"test","count":1,"language":"en-US"}}')

            if echo "\$response" | grep -q '"success":true'; then
              echo "âœ… AI API is working!"
              echo "Response: \$response"
            else
              echo "âš ï¸  API response: \$response"
              if echo "\$response" | grep -q "APIå¯†é’¥æœªé…ç½®"; then
                echo "âŒ API key still not configured properly"
                exit 1
              fi
            fi

            echo "ðŸŽ‰ API key update completed!"
          EOF

      - name: Verify update
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST "bash -s" << 'EOF'
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            if docker ps | grep -q maxgamer-api; then
              echo "âœ… Backend container is running"
            else
              echo "âŒ Backend container is not running"
              exit 1
            fi

            echo "ðŸŽ‰ Verification successful!"
          EOF

      - name: Send notification
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… API key updated successfully!"
          else
            echo "âŒ Failed to update API key!"
          fi
