<!-- 用户管理页面 (管理员) - 统一风格 -->
<div class="page-container">
    <!-- 页面头部 -->
    <div class="page-header">
        <h1 class="page-title">用户管理</h1>
        <p class="page-subtitle">管理平台所有注册账号、权限和点数</p>
    </div>

    <!-- 页面内容 -->
    <div class="page-body">
        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #e3f2fd; color: #1565c0;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">总用户数</div>
                    <div class="stat-value" id="statTotalUsers">-</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #e8f5e9; color: #2e7d32;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">创作者</div>
                    <div class="stat-value" id="statCreators">-</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fff3e0; color: #e65100;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">管理员</div>
                    <div class="stat-value" id="statAdmins">-</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #f3e5f5; color: #7b1fa2;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">平台总点数</div>
                    <div class="stat-value" id="statTotalBalance">-</div>
                </div>
            </div>
        </div>

        <!-- 工具栏 -->
        <div class="content-toolbar">
            <div class="toolbar-left">
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="搜索邮箱、昵称或手机号...">
                </div>
            </div>
            <div class="toolbar-right">
                <button class="btn-primary" onclick="AdminUsers.openCreateModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    添加用户
                </button>
            </div>
        </div>

        <!-- 用户表格 -->
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>用户</th>
                        <th>角色</th>
                        <th>状态</th>
                        <th>点数余额</th>
                        <th>注册时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- 用户数据将动态渲染 -->
                </tbody>
            </table>
            
            <div class="empty-state" id="emptyState" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <h3>暂无用户</h3>
                <p>还没有注册用户</p>
            </div>
            
            <div class="pagination" id="pagination">
                <div class="pagination-info" id="paginationInfo">显示 0-0 共 0 条</div>
                <div class="pagination-btns">
                    <button class="btn-page" id="btnPrev" onclick="AdminUsers.prevPage()" disabled>上一页</button>
                    <button class="btn-page" id="btnNext" onclick="AdminUsers.nextPage()" disabled>下一页</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 创建/编辑用户模态框 -->
<div class="modal-overlay" id="userModal" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3 id="modalTitle">添加用户</h3>
            <button class="btn-close" onclick="AdminUsers.closeModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editUserId">
            
            <div class="form-group">
                <label>邮箱 *</label>
                <input type="email" id="userEmail" placeholder="user@example.com">
            </div>
            
            <div class="form-group">
                <label>手机号</label>
                <input type="tel" id="userPhone" placeholder="13800138000">
            </div>
            
            <div class="form-group">
                <label>昵称</label>
                <input type="text" id="userNickname" placeholder="用户昵称">
            </div>
            
            <div class="form-group" id="passwordGroup">
                <label>密码</label>
                <input type="password" id="userPassword" placeholder="留空则不修改密码">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>角色</label>
                    <select id="userRole">
                        <option value="user">普通用户</option>
                        <option value="creator">创作者</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>状态</label>
                    <select id="userStatus">
                        <option value="active">正常</option>
                        <option value="banned">封禁</option>
                        <option value="suspended">暂停</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" id="balanceGroup" style="display: none;">
                <label>初始点数</label>
                <input type="number" id="userBalance" value="0" min="0">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="AdminUsers.closeModal()">取消</button>
            <button class="btn-primary" id="btnSaveUser" onclick="AdminUsers.saveUser()">保存</button>
        </div>
    </div>
</div>

<!-- 调整点数模态框 -->
<div class="modal-overlay" id="pointsModal" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3>调整点数</h3>
            <button class="btn-close" onclick="AdminUsers.closePointsModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="pointsUserId">
            
            <div class="form-group">
                <label>用户</label>
                <input type="text" id="pointsUserInfo" disabled>
            </div>
            
            <div class="form-group">
                <label>当前余额</label>
                <input type="text" id="pointsCurrentBalance" disabled>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>操作类型</label>
                    <select id="pointsAction" onchange="AdminUsers.updatePointsPreview()">
                        <option value="add">增加点数</option>
                        <option value="subtract">扣除点数</option>
                        <option value="set">直接设置</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>数量</label>
                    <input type="number" id="pointsAmount" value="0" min="0" onchange="AdminUsers.updatePointsPreview()">
                </div>
            </div>
            
            <div class="form-group">
                <label>调整后余额</label>
                <input type="text" id="pointsNewBalance" disabled style="font-weight: 500; color: #1a73e8;">
            </div>
            
            <div class="form-group">
                <label>调整原因</label>
                <textarea id="pointsReason" placeholder="请输入调整原因（如：退款、补偿、测试等）"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="AdminUsers.closePointsModal()">取消</button>
            <button class="btn-primary" onclick="AdminUsers.adjustPoints()">确认调整</button>
        </div>
    </div>
</div>

<style>
/* ========== 全局字体 ========== */
* {
    font-family: 'Noto Sans SC', 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
}

/* ========== 统一页面容器 ========== */
.page-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #fff;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* 页面头部 */
.page-header {
    padding: 24px 32px 20px;
    border-bottom: 1px solid #e8eaed;
    background: #fff;
    flex-shrink: 0;
}

.page-title {
    font-size: 22px;
    font-weight: 400;
    color: #202124;
    margin: 0 0 4px 0;
    letter-spacing: -0.2px;
}

.page-subtitle {
    font-size: 14px;
    color: #5f6368;
    margin: 0;
    font-weight: 400;
}

/* 页面主体 */
.page-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px;
}

/* ========== 统计卡片 ========== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: #fff;
    border: 1px solid #e8eaed;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s ease;
}

.stat-card:hover {
    border-color: #dadce0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.stat-icon svg {
    width: 24px;
    height: 24px;
}

.stat-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.stat-label {
    font-size: 13px;
    color: #5f6368;
    font-weight: 400;
}

.stat-value {
    font-size: 24px;
    font-weight: 500;
    color: #202124;
}

/* ========== 工具栏 ========== */
.content-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
    flex-wrap: wrap;
}

.toolbar-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.search-box {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: #f1f3f4;
    border-radius: 8px;
    min-width: 300px;
}

.search-box svg {
    width: 18px;
    height: 18px;
    color: #5f6368;
    flex-shrink: 0;
}

.search-box input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 14px;
    color: #202124;
    outline: none;
}

.search-box input::placeholder {
    color: #9aa0a6;
}

/* ========== 按钮 ========== */
.btn-primary {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-primary:hover {
    background: #1557b0;
    box-shadow: 0 2px 6px rgba(26, 115, 232, 0.3);
}

.btn-primary svg {
    width: 18px;
    height: 18px;
}

.btn-secondary {
    padding: 10px 20px;
    background: #fff;
    color: #5f6368;
    border: 1px solid #dadce0;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-secondary:hover {
    background: #f8f9fa;
    border-color: #c6c9cc;
}

/* ========== 数据表格 ========== */
.data-table-container {
    background: #fff;
    border: 1px solid #e8eaed;
    border-radius: 12px;
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid #e8eaed;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 500;
    color: #5f6368;
    font-size: 13px;
}

.data-table td {
    color: #202124;
    font-size: 14px;
}

.data-table tbody tr:hover {
    background: #f8f9fa;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

/* 用户信息单元格 */
.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    min-width: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 500;
    font-size: 16px;
    flex-shrink: 0;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.user-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
}

.user-nickname {
    font-weight: 500;
    font-size: 14px;
    color: #202124;
    white-space: nowrap;
}

.user-email {
    font-size: 12px;
    color: #5f6368;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 角色/状态徽章 */
.role-badge, .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.role-admin { background: #e8f5e9; color: #1b5e20; }
.role-creator { background: #e3f2fd; color: #1565c0; }
.role-user { background: #f5f5f5; color: #616161; }

.status-active { background: #e8f5e9; color: #1b5e20; }
.status-banned { background: #ffebee; color: #c62828; }
.status-suspended { background: #fff3e0; color: #e65100; }

.balance-cell {
    font-weight: 500;
    color: #1a73e8;
}

/* 操作按钮组 */
.action-btns {
    display: flex;
    gap: 8px;
}

.btn-action {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-edit { background: #f1f3f4; color: #202124; }
.btn-edit:hover { background: #e8eaed; }
.btn-points { background: #e3f2fd; color: #1565c0; }
.btn-points:hover { background: #bbdefb; }
.btn-delete { background: #ffebee; color: #c62828; }
.btn-delete:hover { background: #ffcdd2; }

/* ========== 分页 ========== */
.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-top: 1px solid #e8eaed;
}

.pagination-info {
    font-size: 14px;
    color: #5f6368;
}

.pagination-btns {
    display: flex;
    gap: 8px;
}

.btn-page {
    padding: 8px 16px;
    border: 1px solid #dadce0;
    background: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    color: #202124;
    transition: all 0.15s ease;
}

.btn-page:hover:not(:disabled) {
    background: #f1f3f4;
}

.btn-page:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ========== 空状态 ========== */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #5f6368;
}

.empty-state svg {
    width: 64px;
    height: 64px;
    color: #9aa0a6;
    margin-bottom: 16px;
}

.empty-state h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
    font-weight: 500;
    color: #202124;
}

.empty-state p {
    margin: 0;
    font-size: 14px;
    color: #5f6368;
}

/* ========== 弹窗 ========== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-dialog {
    background: #fff;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid #e8eaed;
}

.modal-header h3 {
    font-size: 18px;
    font-weight: 500;
    color: #202124;
    margin: 0;
}

.btn-close {
    width: 36px;
    height: 36px;
    border: none;
    background: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #5f6368;
    transition: background 0.15s ease;
}

.btn-close:hover {
    background: #f1f3f4;
}

.btn-close svg {
    width: 20px;
    height: 20px;
}

.modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid #e8eaed;
}

/* ========== 表单 ========== */
.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: #202124;
    margin-bottom: 6px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #dadce0;
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
    color: #202124;
    box-sizing: border-box;
    transition: border-color 0.15s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #1a73e8;
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

/* ========== 响应式 ========== */
@media (max-width: 768px) {
    .page-header {
        padding: 20px;
    }
    
    .page-body {
        padding: 20px;
    }
    
    .content-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        min-width: auto;
        width: 100%;
    }
    
    .toolbar-right {
        justify-content: flex-end;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .data-table-container {
        overflow-x: auto;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
const AdminUsers = {
    users: [],
    currentPage: 0,
    pageSize: 20,
    total: 0,
    searchKeyword: '',
    
    async init() {
        console.log('[AdminUsers] 初始化...');
        
        // 绑定搜索回车事件
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.search();
        });
        
        await this.loadUsers();
        await this.loadStats();
    },
    
    async loadStats() {
        try {
            const response = await AuthManager.authenticatedFetch(
                `${AuthManager.apiBaseUrl}/admin/stats`
            );
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('statTotalUsers').textContent = data.stats.users.total;
                document.getElementById('statAdmins').textContent = data.stats.users.admins;
                document.getElementById('statCreators').textContent = '-';
                document.getElementById('statTotalBalance').textContent = '-';
            }
        } catch (error) {
            console.error('[AdminUsers] 加载统计失败:', error);
        }
    },
    
    async loadUsers() {
        try {
            const offset = this.currentPage * this.pageSize;
            let url = `${AuthManager.apiBaseUrl}/admin/users?limit=${this.pageSize}&offset=${offset}`;
            
            if (this.searchKeyword) {
                url += `&search=${encodeURIComponent(this.searchKeyword)}`;
            }
            
            const response = await AuthManager.authenticatedFetch(url);
            const data = await response.json();
            
            if (data.success) {
                this.users = data.users;
                this.total = data.total;
                this.renderUsers();
                this.updatePagination();
            }
        } catch (error) {
            console.error('[AdminUsers] 加载用户失败:', error);
        }
    },
    
    renderUsers() {
        const tbody = document.getElementById('usersTableBody');
        const empty = document.getElementById('emptyState');
        const pagination = document.getElementById('pagination');
        
        if (this.users.length === 0) {
            tbody.innerHTML = '';
            empty.style.display = 'block';
            pagination.style.display = 'none';
            return;
        }
        
        empty.style.display = 'none';
        pagination.style.display = 'flex';
        
        tbody.innerHTML = this.users.map(user => `
            <tr>
                <td>
                    <div class="user-info">
                        <div class="user-avatar">
                            ${user.avatar_url 
                                ? `<img src="${user.avatar_url}" alt="${user.nickname}">`
                                : (user.nickname ? user.nickname[0].toUpperCase() : 'U')
                            }
                        </div>
                        <div class="user-details">
                            <span class="user-nickname">${user.nickname || '未设置'}</span>
                            <span class="user-email">${user.email || user.phone || 'ID: ' + user.id}</span>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="role-badge role-${user.role}">${this.getRoleText(user.role)}</span>
                </td>
                <td>
                    <span class="status-badge status-${user.status}">${this.getStatusText(user.status)}</span>
                </td>
                <td class="balance-cell">${user.balance || 0} MP</td>
                <td>${this.formatDate(user.created_at)}</td>
                <td>
                    <div class="action-btns">
                        <button class="btn-action btn-edit" onclick="AdminUsers.editUser(${user.id})">编辑</button>
                        <button class="btn-action btn-points" onclick="AdminUsers.openPointsModal(${user.id})">点数</button>
                        <button class="btn-action btn-delete" onclick="AdminUsers.deleteUser(${user.id})">删除</button>
                    </div>
                </td>
            </tr>
        `).join('');
    },
    
    getRoleText(role) {
        const texts = { 'user': '用户', 'creator': '创作者', 'admin': '管理员' };
        return texts[role] || role;
    },
    
    getStatusText(status) {
        const texts = { 'active': '正常', 'banned': '封禁', 'suspended': '暂停' };
        return texts[status] || status;
    },
    
    formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
    },
    
    updatePagination() {
        const start = this.currentPage * this.pageSize + 1;
        const end = Math.min((this.currentPage + 1) * this.pageSize, this.total);
        
        document.getElementById('paginationInfo').textContent = 
            `显示 ${this.total > 0 ? start : 0}-${end} 共 ${this.total} 条`;
        
        document.getElementById('btnPrev').disabled = this.currentPage === 0;
        document.getElementById('btnNext').disabled = end >= this.total;
    },
    
    prevPage() {
        if (this.currentPage > 0) {
            this.currentPage--;
            this.loadUsers();
        }
    },
    
    nextPage() {
        const maxPage = Math.ceil(this.total / this.pageSize) - 1;
        if (this.currentPage < maxPage) {
            this.currentPage++;
            this.loadUsers();
        }
    },
    
    search() {
        this.searchKeyword = document.getElementById('searchInput').value.trim();
        this.currentPage = 0;
        this.loadUsers();
    },
    
    // 创建用户相关
    openCreateModal() {
        document.getElementById('modalTitle').textContent = '添加用户';
        document.getElementById('editUserId').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userPhone').value = '';
        document.getElementById('userNickname').value = '';
        document.getElementById('userPassword').value = '';
        document.getElementById('userRole').value = 'user';
        document.getElementById('userStatus').value = 'active';
        document.getElementById('userBalance').value = '0';
        
        document.getElementById('passwordGroup').querySelector('label').textContent = '密码 *';
        document.getElementById('balanceGroup').style.display = 'block';
        
        document.getElementById('userModal').style.display = 'flex';
    },
    
    async editUser(userId) {
        try {
            const response = await AuthManager.authenticatedFetch(
                `${AuthManager.apiBaseUrl}/admin/users/${userId}`
            );
            const data = await response.json();
            
            if (data.success) {
                const user = data.user;
                
                document.getElementById('modalTitle').textContent = '编辑用户';
                document.getElementById('editUserId').value = user.id;
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userPhone').value = user.phone || '';
                document.getElementById('userNickname').value = user.nickname || '';
                document.getElementById('userPassword').value = '';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userStatus').value = user.status;
                
                document.getElementById('passwordGroup').querySelector('label').textContent = '密码（留空不修改）';
                document.getElementById('balanceGroup').style.display = 'none';
                
                document.getElementById('userModal').style.display = 'flex';
            }
        } catch (error) {
            console.error('[AdminUsers] 获取用户详情失败:', error);
            alert('获取用户信息失败');
        }
    },
    
    closeModal() {
        document.getElementById('userModal').style.display = 'none';
    },
    
    async saveUser() {
        const userId = document.getElementById('editUserId').value;
        const isEdit = !!userId;
        
        const email = document.getElementById('userEmail').value.trim();
        const phone = document.getElementById('userPhone').value.trim();
        const nickname = document.getElementById('userNickname').value.trim();
        const password = document.getElementById('userPassword').value;
        const role = document.getElementById('userRole').value;
        const status = document.getElementById('userStatus').value;
        const balance = parseInt(document.getElementById('userBalance').value) || 0;
        
        if (!email) {
            alert('请输入邮箱');
            return;
        }
        
        if (!isEdit && !password) {
            alert('请输入密码');
            return;
        }
        
        const btn = document.getElementById('btnSaveUser');
        btn.disabled = true;
        btn.textContent = '保存中...';
        
        try {
            let url, method;
            const body = { email, phone, nickname, role, status };
            
            if (password) body.password = password;
            
            if (isEdit) {
                url = `${AuthManager.apiBaseUrl}/admin/users/${userId}`;
                method = 'PUT';
            } else {
                url = `${AuthManager.apiBaseUrl}/admin/users`;
                method = 'POST';
                body.balance = balance;
            }
            
            const response = await AuthManager.authenticatedFetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.closeModal();
                this.loadUsers();
                alert(isEdit ? '用户信息已更新' : '用户创建成功');
            } else {
                alert(data.message || data.error || '操作失败');
            }
        } catch (error) {
            console.error('[AdminUsers] 保存用户失败:', error);
            alert('操作失败: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = '保存';
        }
    },
    
    async deleteUser(userId) {
        if (!confirm('确定要删除该用户吗？此操作不可恢复，用户的所有数据都将被删除。')) return;
        
        try {
            const response = await AuthManager.authenticatedFetch(
                `${AuthManager.apiBaseUrl}/admin/users/${userId}`,
                { method: 'DELETE' }
            );
            
            const data = await response.json();
            
            if (data.success) {
                this.loadUsers();
                alert('用户已删除');
            } else {
                alert(data.message || data.error || '删除失败');
            }
        } catch (error) {
            console.error('[AdminUsers] 删除用户失败:', error);
            alert('删除失败: ' + error.message);
        }
    },
    
    // 点数调整相关
    openPointsModal(userId) {
        const user = this.users.find(u => u.id === userId);
        if (!user) return;
        
        document.getElementById('pointsUserId').value = userId;
        document.getElementById('pointsUserInfo').value = `${user.nickname || '未设置'} (${user.email || user.phone || 'ID: ' + user.id})`;
        document.getElementById('pointsCurrentBalance').value = `${user.balance || 0} MP`;
        document.getElementById('pointsAction').value = 'add';
        document.getElementById('pointsAmount').value = '0';
        document.getElementById('pointsReason').value = '';
        
        this.updatePointsPreview();
        
        document.getElementById('pointsModal').style.display = 'flex';
    },
    
    closePointsModal() {
        document.getElementById('pointsModal').style.display = 'none';
    },
    
    updatePointsPreview() {
        const userId = document.getElementById('pointsUserId').value;
        const user = this.users.find(u => u.id === parseInt(userId));
        if (!user) return;
        
        const currentBalance = user.balance || 0;
        const action = document.getElementById('pointsAction').value;
        const amount = parseInt(document.getElementById('pointsAmount').value) || 0;
        
        let newBalance;
        if (action === 'add') {
            newBalance = currentBalance + amount;
        } else if (action === 'subtract') {
            newBalance = Math.max(0, currentBalance - amount);
        } else {
            newBalance = amount;
        }
        
        document.getElementById('pointsNewBalance').value = `${newBalance} MP`;
    },
    
    async adjustPoints() {
        const userId = document.getElementById('pointsUserId').value;
        const action = document.getElementById('pointsAction').value;
        const amount = parseInt(document.getElementById('pointsAmount').value) || 0;
        const reason = document.getElementById('pointsReason').value.trim();
        
        if (amount <= 0 && action !== 'set') {
            alert('请输入有效的调整数量');
            return;
        }
        
        if (!reason) {
            alert('请输入调整原因');
            return;
        }
        
        try {
            let url, body;
            
            if (action === 'set') {
                url = `${AuthManager.apiBaseUrl}/admin/users/${userId}/set-balance`;
                body = { balance: amount, reason };
            } else {
                url = `${AuthManager.apiBaseUrl}/admin/users/${userId}/adjust-balance`;
                const adjustAmount = action === 'add' ? amount : -amount;
                body = { amount: adjustAmount, reason };
            }
            
            const response = await AuthManager.authenticatedFetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.closePointsModal();
                this.loadUsers();
                alert(`点数调整成功：${data.balance_before} → ${data.balance_after} MP`);
            } else {
                alert(data.message || data.error || '调整失败');
            }
        } catch (error) {
            console.error('[AdminUsers] 调整点数失败:', error);
            alert('调整失败: ' + error.message);
        }
    }
};

// 导出到全局
window.AdminUsers = AdminUsers;
</script>
