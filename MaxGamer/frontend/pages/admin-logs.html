<!-- ç®¡ç†æ—¥å¿—é¡µé¢ (ç®¡ç†å‘˜) - ç»Ÿä¸€é£æ ¼ -->
<div class="page-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <h1 class="page-title">ç®¡ç†æ—¥å¿—</h1>
        <p class="page-subtitle">æŸ¥çœ‹ç®¡ç†å‘˜çš„æ‰€æœ‰æ“ä½œè®°å½•</p>
    </div>

    <!-- é¡µé¢å†…å®¹ -->
    <div class="page-body">
        <!-- å·¥å…·æ  -->
        <div class="content-toolbar">
            <div class="toolbar-left">
                <div class="filter-group">
                    <select class="filter-select" id="filterAction" onchange="AdminLogs.filter()">
                        <option value="">å…¨éƒ¨æ“ä½œ</option>
                    </select>
                    <select class="filter-select" id="filterTargetType" onchange="AdminLogs.filter()">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="user">ç”¨æˆ·</option>
                        <option value="game">æ¸¸æˆ</option>
                        <option value="system">ç³»ç»Ÿ</option>
                    </select>
                </div>
            </div>
            <div class="toolbar-right">
                <button class="btn-secondary" onclick="AdminLogs.refresh()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6"/>
                        <path d="M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- æ—¥å¿—è¡¨æ ¼ -->
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>ç®¡ç†å‘˜</th>
                        <th>æ“ä½œ</th>
                        <th>ç›®æ ‡</th>
                        <th>è¯¦æƒ…</th>
                        <th>IPåœ°å€</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    <!-- æ—¥å¿—æ•°æ®å°†åŠ¨æ€æ¸²æŸ“ -->
                </tbody>
            </table>
            
            <div class="empty-state" id="emptyState" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <h3>æš‚æ— æ—¥å¿—</h3>
                <p>è¿˜æ²¡æœ‰ç®¡ç†æ“ä½œè®°å½•</p>
            </div>
            
            <div class="pagination" id="pagination">
                <div class="pagination-info" id="paginationInfo">æ˜¾ç¤º 0-0 å…± 0 æ¡</div>
                <div class="pagination-btns">
                    <button class="btn-page" id="btnPrev" onclick="AdminLogs.prevPage()" disabled>ä¸Šä¸€é¡µ</button>
                    <button class="btn-page" id="btnNext" onclick="AdminLogs.nextPage()" disabled>ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ========== å…¨å±€å­—ä½“ ========== */
* {
    font-family: 'Noto Sans SC', 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
}

/* ========== ç»Ÿä¸€é¡µé¢å®¹å™¨ ========== */
.page-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #fff;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* é¡µé¢å¤´éƒ¨ */
.page-header {
    padding: 24px 32px 20px;
    border-bottom: 1px solid #e8eaed;
    background: #fff;
    flex-shrink: 0;
}

.page-title {
    font-size: 22px;
    font-weight: 400;
    color: #202124;
    margin: 0 0 4px 0;
    letter-spacing: -0.2px;
}

.page-subtitle {
    font-size: 14px;
    color: #5f6368;
    margin: 0;
    font-weight: 400;
}

/* é¡µé¢ä¸»ä½“ */
.page-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px;
}

/* ========== å·¥å…·æ  ========== */
.content-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
    flex-wrap: wrap;
}

.toolbar-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 12px;
}

.filter-select {
    padding: 8px 12px;
    border: 1px solid #dadce0;
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
    color: #202124;
    min-width: 140px;
    cursor: pointer;
    transition: border-color 0.15s ease;
}

.filter-select:focus {
    outline: none;
    border-color: #1a73e8;
}

/* ========== æŒ‰é’® ========== */
.btn-secondary {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: #fff;
    color: #5f6368;
    border: 1px solid #dadce0;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-secondary:hover {
    background: #f8f9fa;
    border-color: #c6c9cc;
}

.btn-secondary svg {
    width: 18px;
    height: 18px;
}

/* ========== æ•°æ®è¡¨æ ¼ ========== */
.data-table-container {
    background: #fff;
    border: 1px solid #e8eaed;
    border-radius: 12px;
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid #e8eaed;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 500;
    color: #5f6368;
    font-size: 13px;
}

.data-table td {
    color: #202124;
    font-size: 14px;
}

.data-table tbody tr:hover {
    background: #f8f9fa;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

/* æ—¶é—´å•å…ƒæ ¼ */
.log-time {
    color: #5f6368;
    font-size: 13px;
    white-space: nowrap;
}

/* ç®¡ç†å‘˜ä¿¡æ¯ */
.admin-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.admin-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 500;
    font-size: 14px;
    flex-shrink: 0;
}

.admin-details {
    display: flex;
    flex-direction: column;
}

.admin-name {
    font-weight: 500;
    color: #202124;
    font-size: 14px;
}

.admin-email {
    font-size: 12px;
    color: #5f6368;
}

/* æ“ä½œå¾½ç«  */
.action-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.action-login { background: #e0f2fe; color: #0369a1; }
.action-create_user { background: #dcfce7; color: #16a34a; }
.action-edit_user { background: #fef3c7; color: #d97706; }
.action-delete_user { background: #fee2e2; color: #dc2626; }
.action-adjust_balance { background: #f3e8ff; color: #9333ea; }
.action-set_balance { background: #f3e8ff; color: #7c3aed; }
.action-set_role { background: #e0e7ff; color: #4f46e5; }
.action-create_game { background: #d1fae5; color: #059669; }
.action-edit_game { background: #fef9c3; color: #ca8a04; }
.action-delete_game { background: #fecaca; color: #dc2626; }

/* ç›®æ ‡ä¿¡æ¯ */
.target-info {
    display: flex;
    flex-direction: column;
}

.target-type {
    font-size: 11px;
    color: #5f6368;
    text-transform: uppercase;
}

.target-name {
    font-weight: 500;
    color: #202124;
}

/* è¯¦æƒ…å•å…ƒæ ¼ */
.details-cell {
    max-width: 300px;
}

.details-json {
    font-size: 12px;
    color: #5f6368;
    background: #f8f9fa;
    padding: 6px 10px;
    border-radius: 6px;
    font-family: 'Consolas', 'Monaco', monospace;
    word-break: break-all;
    max-height: 60px;
    overflow: hidden;
    cursor: pointer;
    transition: max-height 0.2s ease;
}

.details-json:hover {
    max-height: none;
}

/* IPå•å…ƒæ ¼ */
.ip-cell {
    font-size: 13px;
    color: #5f6368;
    font-family: 'Consolas', 'Monaco', monospace;
}

/* ========== åˆ†é¡µ ========== */
.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-top: 1px solid #e8eaed;
}

.pagination-info {
    font-size: 14px;
    color: #5f6368;
}

.pagination-btns {
    display: flex;
    gap: 8px;
}

.btn-page {
    padding: 8px 16px;
    border: 1px solid #dadce0;
    background: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    color: #202124;
    transition: all 0.15s ease;
}

.btn-page:hover:not(:disabled) {
    background: #f1f3f4;
}

.btn-page:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ========== ç©ºçŠ¶æ€ ========== */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #5f6368;
}

.empty-state svg {
    width: 64px;
    height: 64px;
    color: #9aa0a6;
    margin-bottom: 16px;
}

.empty-state h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
    font-weight: 500;
    color: #202124;
}

.empty-state p {
    margin: 0;
    font-size: 14px;
    color: #5f6368;
}

/* ========== å“åº”å¼ ========== */
@media (max-width: 1200px) {
    .data-table-container {
        overflow-x: auto;
    }
}

@media (max-width: 768px) {
    .page-header {
        padding: 20px;
    }
    
    .page-body {
        padding: 20px;
    }
    
    .content-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        flex-wrap: wrap;
    }
    
    .filter-select {
        flex: 1;
        min-width: 120px;
    }
    
    .toolbar-right {
        justify-content: flex-end;
    }
}
</style>

<script>
const AdminLogs = {
    logs: [],
    currentPage: 0,
    pageSize: 50,
    total: 0,
    actionFilter: '',
    targetTypeFilter: '',
    
    // æ“ä½œç±»å‹æ˜ å°„
    actionLabels: {
        'login': 'ç®¡ç†å‘˜ç™»å½•',
        'create_user': 'åˆ›å»ºç”¨æˆ·',
        'edit_user': 'ç¼–è¾‘ç”¨æˆ·',
        'delete_user': 'åˆ é™¤ç”¨æˆ·',
        'adjust_balance': 'è°ƒæ•´ä½™é¢',
        'set_balance': 'è®¾ç½®ä½™é¢',
        'set_role': 'è®¾ç½®è§’è‰²',
        'create_game': 'åˆ›å»ºæ¸¸æˆ',
        'edit_game': 'ç¼–è¾‘æ¸¸æˆ',
        'delete_game': 'åˆ é™¤æ¸¸æˆ'
    },
    
    async init() {
        console.log('[AdminLogs] åˆå§‹åŒ–...');
        await this.loadActionTypes();
        await this.loadLogs();
    },
    
    async loadActionTypes() {
        try {
            const response = await AuthManager.authenticatedFetch(
                `${AuthManager.apiBaseUrl}/admin/logs/actions`
            );
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('filterAction');
                data.actions.forEach(action => {
                    const option = document.createElement('option');
                    option.value = action.value;
                    option.textContent = action.label;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('[AdminLogs] åŠ è½½æ“ä½œç±»å‹å¤±è´¥:', error);
        }
    },
    
    async loadLogs() {
        try {
            const offset = this.currentPage * this.pageSize;
            let url = `${AuthManager.apiBaseUrl}/admin/logs?limit=${this.pageSize}&offset=${offset}`;
            
            if (this.actionFilter) {
                url += `&action=${encodeURIComponent(this.actionFilter)}`;
            }
            if (this.targetTypeFilter) {
                url += `&target_type=${encodeURIComponent(this.targetTypeFilter)}`;
            }
            
            const response = await AuthManager.authenticatedFetch(url);
            const data = await response.json();
            
            if (data.success) {
                this.logs = data.logs;
                this.total = data.total;
                this.renderLogs();
                this.updatePagination();
            }
        } catch (error) {
            console.error('[AdminLogs] åŠ è½½æ—¥å¿—å¤±è´¥:', error);
        }
    },
    
    renderLogs() {
        const tbody = document.getElementById('logsTableBody');
        const empty = document.getElementById('emptyState');
        const pagination = document.getElementById('pagination');
        
        if (this.logs.length === 0) {
            tbody.innerHTML = '';
            empty.style.display = 'block';
            pagination.style.display = 'none';
            return;
        }
        
        empty.style.display = 'none';
        pagination.style.display = 'flex';
        
        tbody.innerHTML = this.logs.map(log => `
            <tr>
                <td class="log-time">${this.formatTime(log.created_at)}</td>
                <td>
                    <div class="admin-info">
                        <div class="admin-avatar">
                            ${log.admin_nickname ? log.admin_nickname[0].toUpperCase() : 'A'}
                        </div>
                        <div class="admin-details">
                            <span class="admin-name">${log.admin_nickname || 'æœªçŸ¥'}</span>
                            <span class="admin-email">${log.admin_email || '-'}</span>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="action-badge action-${log.action}">
                        ${this.getActionIcon(log.action)}
                        ${this.actionLabels[log.action] || log.action}
                    </span>
                </td>
                <td>
                    ${log.target_type ? `
                        <div class="target-info">
                            <span class="target-type">${this.getTargetTypeLabel(log.target_type)}</span>
                            <span class="target-name">${log.target_name || log.target_id || '-'}</span>
                        </div>
                    ` : '-'}
                </td>
                <td class="details-cell">
                    ${log.details ? `
                        <div class="details-json" title="ç‚¹å‡»å±•å¼€">${this.formatDetails(log.details)}</div>
                    ` : '-'}
                </td>
                <td class="ip-cell">${log.ip_address || '-'}</td>
            </tr>
        `).join('');
    },
    
    getActionIcon(action) {
        const icons = {
            'login': 'ğŸ”',
            'create_user': 'â•',
            'edit_user': 'âœï¸',
            'delete_user': 'ğŸ—‘ï¸',
            'adjust_balance': 'ğŸ’°',
            'set_balance': 'ğŸ’µ',
            'set_role': 'ğŸ‘¤',
            'create_game': 'ğŸ®',
            'edit_game': 'ğŸ”§',
            'delete_game': 'âŒ'
        };
        return icons[action] || 'ğŸ“';
    },
    
    getTargetTypeLabel(type) {
        const labels = {
            'user': 'ç”¨æˆ·',
            'game': 'æ¸¸æˆ',
            'system': 'ç³»ç»Ÿ'
        };
        return labels[type] || type;
    },
    
    formatTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    },
    
    formatDetails(details) {
        if (!details) return '-';
        try {
            return JSON.stringify(details, null, 2);
        } catch {
            return String(details);
        }
    },
    
    updatePagination() {
        const start = this.currentPage * this.pageSize + 1;
        const end = Math.min((this.currentPage + 1) * this.pageSize, this.total);
        
        document.getElementById('paginationInfo').textContent = 
            `æ˜¾ç¤º ${this.total > 0 ? start : 0}-${end} å…± ${this.total} æ¡`;
        
        document.getElementById('btnPrev').disabled = this.currentPage === 0;
        document.getElementById('btnNext').disabled = end >= this.total;
    },
    
    prevPage() {
        if (this.currentPage > 0) {
            this.currentPage--;
            this.loadLogs();
        }
    },
    
    nextPage() {
        const maxPage = Math.ceil(this.total / this.pageSize) - 1;
        if (this.currentPage < maxPage) {
            this.currentPage++;
            this.loadLogs();
        }
    },
    
    filter() {
        this.actionFilter = document.getElementById('filterAction').value;
        this.targetTypeFilter = document.getElementById('filterTargetType').value;
        this.currentPage = 0;
        this.loadLogs();
    },
    
    refresh() {
        this.loadLogs();
    }
};

// å¯¼å‡ºåˆ°å…¨å±€
window.AdminLogs = AdminLogs;

// é¡µé¢åŠ è½½ååˆå§‹åŒ–
if (window.AdminLogs) {
    AdminLogs.init();
}
</script>
